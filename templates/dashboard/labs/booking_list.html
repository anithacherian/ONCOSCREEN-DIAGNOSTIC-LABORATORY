{% extends 'base.html' %}
{% load static %}

{% block content %}
    <!-- Lab Bookings Detail Page -->
    <div class="page-title" data-aos="fade">
      <nav class="breadcrumbs">
        <div class="container">
          <ol>
            <li><a href="/">Home</a></li>
            <li class="current">Lab Bookings</li>
          </ol>
        </div>
      </nav>    <!-- Lab Bookings Section -->

      <!-- View Lab Bookings Section -->
    <section id="contact" class="contact section">

      <!-- Section Title -->
      <div class="container section-title" data-aos="fade-up">
        <h2>View Bookings</h2>
      </div><!-- End Section Title -->



      <div class="container" data-aos="fade-up" data-aos-delay="100">
        {% if messages %}
            {% for message in messages %}
            <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %} alert-dismissible fade show" role="alert">{{message}}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}               
        {% endif %}

          <div class="row justify-content-center g-0">
               <div class="col-lg-12 col-md-10 col-12 p-0 view_table border rounded-3 overflow-hidden">
                    <table class="table table-success table-striped table-hover mb-0" >
                        <thead class="text-white">
                            <tr class="">
                            <th scope="col" class="border-0 thead">#</th>
                            <th scope="col" class="border-0 thead">Patient Name</th>
                            <th scope="col" class="border-0 thead">Package</th>
                            <th scope="col" class="border-0 thead">Date</th>
                            <th scope="col" class="border-0 thead">Slot</th>
                            <th scope="col" class="border-0 thead">Collection</th>
                            <th scope="col" class="border-0 thead">Status</th>
                            <th scope="col" class="border-0 thead">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in bookings %}
                                <tr>
                                    <!-- from booking->patient->patient profile->first name -->
                                <th scope="row">{{ bookings.start_index|add:forloop.counter0 }}</th>
                                <td>{{ booking.patient.patient_profile.first_name|title }} {{ booking.patient.patient_profile.last_name|title }}  </td>
                                <td>{{ booking.package.name }}</td>
                                <td>{{ booking.preferred_date }}</td>
                                <td>
                                    {% if booking.slot %}
                                    {{ booking.slot.get_time_slot_display }}
                                    {% else %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if booking.collection_type == 'HOME' %}
                                    <span class="badge bg-warning">Home</span>
                                    {% else %}
                                    <span class="badge bg-info">Lab</span>
                                    {% endif %}
                                </td>
                                <td class="">
                                    <span class="badge bg-secondary">
                                        {{ booking.status }}
                                    </span>
                                </td>
                                <td class="" >
                                   {% if user.role == 'LAB_ADMIN' or user.role == 'STAFF' %}
                                   
                                        {% if booking.status == 'CONFIRMED' %}
                                            <form action="{% url 'mark_sample_collected' booking.id %}"
                                                method="POST">
                                                {% csrf_token %}
                                                <button type="submit"
                                                        class="btn btn-sm btn-warning"
                                                        onclick="return confirm('Confirm sample collected for this patient?');" style="font-size: 0.9rem;">
                                                    Mark Sample Collected
                                                </button>
                                            </form>
                                        {% elif booking.status in 'SAMPLE COLLECTED REPORT UPLOADED' %}
                                        <!-- <p>Has report value: {{ booking.report.file.name }}</p> -->
                                        <!-- Upload button opens modal -->
                                            <button type="button" class="btn btn-sm {% if booking.has_report %}btn-outline-success{% else %}btn-success{% endif %}" data-bs-toggle="modal" data-bs-target="#uploadReportModal{{ booking.id }}"><i class="fa-solid fa-upload"></i> 
                                                {% if booking.report %}
                                                    Re-upload Report
                                                {% else %}
                                                    Upload Reports
                                                {% endif %}
                                            </button>
                                        {% if booking.has_report %}
                                            <a href="{{ booking.report.file.url }}" class="btn btn-sm btn-outline-primary" target="_blank"> <i class="fa-solid fa-file-pdf"></i> View</a>
                                        {% endif %}
         
                                        {% endif %}
                                    {% endif %}
                                    {% if user.role == 'LAB_ADMIN' and booking.status == 'REPORT UPLOADED' %}
                                            <a href="{{ booking.report.file.url }}" class="btn btn-sm btn-outline-primary mt-1" target="_blank"> <i class="fa-solid fa-file-pdf"></i> View Report </a>
                                            <br>
                                            <form action="{% url 'mark_booking_completed' booking.id %}" method="POST">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-success mt-2" onclick="return confirm('Mark this booking as completed?');"> Mark Completed
                                                </button>
                                            </form>
                                    {% endif %}
                                    {% if booking.status == 'COMPLETED' %}
                                        <span class="badge bg-success mb-1"><i class="fa-solid fa-circle-check"></i> Completed</span>
                                        {% if booking.report.file %}
                                            <br>
                                            <a href="{{ booking.report.file.url }}" class="btn btn-sm btn-outline-primary mt-1" target="_blank"> <i class="fa-solid fa-file-pdf"></i> View Report </a>
                                        {% endif %}

                                    {% endif %}


 <!-------------REPORT UPLOAD Modal -------------------->
<div class="modal fade" id="uploadReportModal{{ booking.id }}" tabindex="-1" aria-labelledby="uploadModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <form method="POST"
            action="{% url 'upload_test_report' booking.id %}"
            enctype="multipart/form-data">
        {% csrf_token %}

        <div class="modal-header">
          <h5 class="modal-title">Upload Report</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Select report file</label>
            <input type="file"
                   name="report_file"
                   class="form-control"
                   required>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-success">
            Upload
          </button>
          <button type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal">
            Cancel
          </button>
        </div>

      </form>

    </div>
  </div>
</div>

 <!-------------REPORT UPLOAD Modal ENDS-------------------->

                                    
                                </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        No bookings available
                                    </td>
                                </tr>
                             {% endfor %}
                        </tbody>
                    </table>
              </div><!-- End Lab Bookings List-->
              <nav aria-label="Labtestavigation" class="mt-3 bg-white ">
                  <ul class="pagination justify-content-center mb-0">
                      <li class="page-item {% if not labtest_page.has_previous %}disabled{% endif %}">
                          <a class="page-link" href="{% if bookings.has_previous %}?page={{ bookings.previous_page_number }}{% else %}#{% endif %}">Previous</a>
                      </li>
                      {% for num in bookings.paginator.page_range %}
                      <li class="page-item {% if num == bookings.number %}active{% endif %}" {% if num == bookings.number %}aria-current="page"{% endif %}>
                          <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                      </li>
                      {% endfor %}
                      
                      <li class="page-item {% if not bookings.has_next %}disabled{% endif %}">
                          <a class="page-link" href="{% if bookings.has_next %}?page={{ bookings.next_page_number }}{% else %}#{% endif %}">Next</a>
                      </li>
                      
                  </ul>
              </nav>

          </div>


        </div>

      </div>

    </section><!-- /Lab Bookings Section -->
   

{% endblock %} 