{% extends 'base.html' %}
{% load static %}

{% block content %}
    <!-- Payment List Detail Page -->
    <div class="page-title" data-aos="fade">
      <nav class="breadcrumbs">
        <div class="container">
          <ol>
            <li><a href="/">Home</a></li>
            <li class="current">Payment Status Summary</li>
          </ol>
        </div>
      </nav>    <!-- Payment List Section -->

      <!-- View Payment List Section -->
    <section id="contact" class="contact section">

      <!-- Section Title -->
      <div class="container section-title" data-aos="fade-up">
        <h2>Search Packages</h2>
      </div><!-- End Section Title -->



      <div class="container" data-aos="fade-up" data-aos-delay="100">
        {% if messages %}
            {% for message in messages %}
            <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %} alert-dismissible fade show" role="alert">{{message}}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}               
        {% endif %}
        <!-- {% if form.errors %}
            <div class="alert alert-danger" style="display: block !important;">
                <strong>Form Errors:</strong>
                <ul>
                    {% for field, errors in form.errors.items %}
                        <li>{{ field }}: {{ errors|striptags }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %} -->
       

        <form method="GET" action="{% url 'lab_payment_list' %}" class="row gy-2 gx-3 align-items-center mb-3 justify-content-center">
            <div class="col-auto">
                <select name="status" class="form-select" id="autoSizingSelect">
                    <option value="">All Status</option>
                    <option value="SUCCESS" {% if status_selected == "SUCCESS" %}selected{% endif %}>Success</option>
                    <option value="PENDING" {% if status_selected == "PENDING" %}selected{% endif %}>Pending</option>
                    <option value="FAILED" {% if status_selected == "FAILED" %}selected{% endif %}>Failed</option>
                    <option value="REFUNDED" {% if status_selected == "REFUNDED" %}selected{% endif %}>Refunded</option>
                </select>
            </div>
            <div class="col-auto">
                <input type="date" class="form-control" id="autoSizingInput"   name="start_date" value="{{ start_date }}">
            </div>
            <div class="col-auto">
                <input type="date" class="form-control" id="autoSizingInput" name="end_date" value="{{ end_date }}">
            </div>
            

            <div class="col-auto">
                <input type="text"class="form-control" id="autoSizingInput"  name="search" placeholder="Search by email or booking ID" value="{{ request.GET.search }}">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Apply</button>
            </div>
            <div class="col-auto">
                <button type="submit" name="export" value="true" class="btn btn-success">Export CSV</button>
            </div>
            <div class="col-auto">
                 <a href="{% url 'lab_payment_list' %}"  class="btn btn-primary">Clear</a>
            </div>
        </form>

        <!-- <form method="get">

            <select name="status">
                <option value="">All Status</option>
                <option value="SUCCESS" {% if status_selected == "SUCCESS" %}selected{% endif %}>Success</option>
                <option value="PENDING" {% if status_selected == "PENDING" %}selected{% endif %}>Pending</option>
                <option value="FAILED" {% if status_selected == "FAILED" %}selected{% endif %}>Failed</option>
                <option value="REFUNDED" {% if status_selected == "REFUNDED" %}selected{% endif %}>Refunded</option>
            </select>

            <input type="date" name="start_date" value="{{ start_date }}">
            <input type="date" name="end_date" value="{{ end_date }}">

            <button type="submit">Apply</button>

            <a href="{% url 'lab_payment_list' %}">Clear</a>

        </form> -->
          <div class="row justify-content-center g-0">
               <div class="col-lg-12 col-md-10 col-12 p-0 view_table border rounded-3 overflow-hidden">

                    <table class="table table-success table-striped table-hover mb-0" >
                        <thead class="text-white">
                            <tr class="">
                            <th scope="col" class="border-0 thead">#</th>
                            <th scope="col" class="border-0 thead">Date</th>
                            <th scope="col" class="border-0 thead">Booking ID</th>
                            <th scope="col" class="border-0 thead">Patient</th>
                            <th scope="col" class="border-0 thead">Amount</th>
                            <th scope="col" class="border-0 thead">Payment Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments %}
                                <tr>
                                    <!-- from booking->patient->patient profile->first name -->
                                <th scope="row">{{ payments.start_index|add:forloop.counter0 }}</th>
                                <td>{{ payment.created_at|date:"d M Y H:i" }}</td>
                                <td>{{ payment.booking.id }}</td>
                                <td>{{ payment.booking.patient.email }}</td>
                                <td>{{ payment.amount }}</td>
                               <td>
                                    {% if payment.status == 'SUCCESS' %}
                                        {% if payment.can_be_refunded %}
                                            <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#refundModal{{ payment.id }}"  data-amount="{{ payment.amount }}"> Refund </button>
                                        {% else %}
                                            <span class="badge bg-secondary text-light">üö´ No refund available</span>
                                        {% endif %}
                                    {% elif payment.status == "PENDING" %}
                                    <span class="badge bg-success">‚è≥ Pending</span>
                                    {% elif payment.status == "FAILED" %}
                                    <span class="badge bg-danger">‚úñ Failed</span>
                                    {% else %}
                                    <span class="badge bg-secondary text-light">‚Ü©Ô∏è Refunded</span>
                                    {% endif %}
                                </td>
                                </tr>

<div class="modal fade" id="refundModal{{ payment.id }}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      
      <form method="POST" action="{% url 'refund_payment' payment.id %}" id="refundForm">
        {% csrf_token %}
        
        <div class="modal-header">
          <h5 class="modal-title">Confirm Refund</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <p>Are you sure you want to refund ‚Çπ {{ payment.amount }}?</p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-danger">
            Confirm Refund
          </button>
        </div>

      </form>

    </div>
  </div>
</div>



                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <div class="alert alert-danger" role="alert">No Payments found</div>
                                    </td>
                                </tr>
                             {% endfor %}
                        </tbody>
                    </table>
              </div><!-- End Payment List List-->

            <nav aria-label="Paymentnagivation" class="mt-3 bg-white ">
                <ul class="pagination justify-content-center mb-0">
                    
                    <!-- Previous Button -->
                    <li class="page-item {% if not payments.has_previous %}disabled{% endif %}">
                        {% if payments.has_previous %}
                            <a class="page-link" href="?page={{ payments.previous_page_number }}&status={{ status_selected|default:'' }}&start_date={{ start_date|default:'' }}&end_date={{ end_date|default:'' }}&search={{ request.GET.search }}">Previous</a>
                        {% else %}
                            <span class="page-link">Previous</span>
                        {% endif %}
                    </li>

                    <!-- Page Numbers -->
                    {% for num in payments.paginator.page_range %}
                    <li class="page-item {% if num == payments.number %}active{% endif %}">
                        <a class="page-link" href="?page={{ num }}&status={{ status_selected|default:'' }}&start_date={{ start_date|default:'' }}&end_date={{ end_date|default:'' }}&search={{ request.GET.search }}">{{ num }}</a>
                    </li>
                    {% endfor %}

                    <!-- Next Button -->
                    <li class="page-item {% if not payments.has_next %}disabled{% endif %}">
                        {% if payments.has_next %}
                            <a class="page-link" href="?page={{ payments.next_page_number }}&status={{ status_selected|default:'' }}&start_date={{ start_date|default:'' }}&end_date={{ end_date|default:'' }}&search={{ request.GET.search }}">Next</a>
                        {% else %}
                            <span class="page-link">Next</span>
                        {% endif %}
                    </li>
                    
                </ul>
            </nav>

          </div>


        </div>
      <!-- Section Title -->
      <div class="container section-title" data-aos="fade-up">
        
        <h2>Payment Status Summary</h2>
      </div><!-- End Section Title -->

      <div class="container" data-aos="fade-up" data-aos-delay="100">

        <div style="display:flex; gap:20px; margin-bottom:20px;">

    <div style="padding:15px;" class="alert alert-success">
        <h4>Total Revenue</h4>
        <h3>‚Çπ {{ total_revenue }}</h3>
    </div>

    <div style="padding:15px;" class="alert alert-primary">
        <h4>Today's Collection</h4>
        <h3>‚Çπ {{ today_collection }}</h3>
    </div>

    <div style="padding:15px;" class="alert alert-secondary">
        <h4>Pending Payments</h4>
        <h3>{{ pending_count }}</h3>
    </div>

    <div style="padding:15px; " class="alert alert-danger">
        <h4>Failed Payments</h4>
        <h3>{{ failed_count }}</h3>
    </div>

</div>



          <div class="row justify-content-center g-0">
               <div class="col-lg-12 col-md-10 col-12 p-0 view_table border rounded-3 overflow-hidden">
                <div style="width: 450px; height: 350px; display: block; margin: 0 auto;" c>
                    <canvas id="paymentChart" width="400" height="200"></canvas>

                </div>
                    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script>
                const data = {
                labels: [{% for s in stats %}"{{ s.status }}",{% endfor %}],
                
                datasets: [{
                    data: [{% for s in stats %}{{ s.total }},{% endfor %}],
                    backgroundColor: [
                        '#dc3545',   // Failed (Red)                      
                        '#ffc107', // Pending (Yellow)
                        '#17a2b8' , // Refunded (Blue)
                        '#28a745', // Success (Green)
                        
                    ]
                }]
                };

                new Chart(document.getElementById('paymentChart'), {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                     plugins: {
                        legend: {
                            position: 'top',
                            }
                        }
                    }
                });const myChart = new Chart(document.getElementById('paymentChart'), config);
                </script>


            </div><!-- End Status Summary List-->

          </div>
      

      </div>
      <!-- Section Title -->
      <div class="container section-title mt-4" data-aos="fade-up">
        
        <h2>Monthly Revenue</h2>
      </div><!-- End Section Title -->

      <div class="container" data-aos="fade-up" data-aos-delay="100">
          <div class="row justify-content-center g-0">
              <div class="mb-3 justify-content-center">
                  <a href="?chart=daily"  class="btn btn-sm {% if chart_type == 'daily' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                      Daily
                  </a>

                  <a href="?chart=monthly" class="btn btn-sm {% if chart_type == 'monthly' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                      Monthly
                  </a>
              </div>
               <div class="col-lg-12 col-md-10 col-12 p-0 view_table border rounded-3 overflow-hidden">
                    <div style="width:100%; height:300px;">
                        <canvas id="monthlyRevenueChart"></canvas>
                    </div>
                    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                    <script>
                        const ctx = document.getElementById('monthlyRevenueChart');

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: {{ labels|safe }},
                                datasets: [{
                                    label: 'Revenue (‚Çπ)',
                                    data: {{ revenues|safe }},
                                    fill: false,
                                    tension: 0.3
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                    </script>


            </div><!-- End Status Summary List-->

          </div>
      

      </div>

    </section><!-- /Payment List Section -->
   

{% endblock %} 